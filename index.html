<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ì ì‹¬ ë£°ë ›</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans KR í°íŠ¸ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš© */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* ë£°ë › ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í‚¤í”„ë ˆì„ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(3600deg); } /* 10ë°”í€´ */
        }
        .spinning {
            animation: spin 3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }
        /* ê²°ê³¼ íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-pop {
            animation: pop 0.5s ease-out forwards;
        }
        /* Clickable images */
        .clickable-img {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .clickable-img:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* Shake animation for review input error */
        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-xl rounded-2xl shadow-xl p-6 md:p-8">
        
        <!-- í—¤ë” -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ğŸ˜‹</h1>
            <p class="text-gray-500 mt-2">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ì‹¬ ë©”ë‰´ë¥¼ ë½‘ì•„ë³´ì„¸ìš”!</p>
        </header>

        <!-- URL ì…ë ¥ì°½ (í˜„ì¬ í•˜ë“œì½”ë”©ìœ¼ë¡œ ìˆ¨ê¹€) -->
        <div class="mb-4 hidden">
            <label for="sheet-url" class="block text-sm font-medium text-gray-700 mb-1">Google Sheets CSV URL</label>
            <input type="text" id="sheet-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="Google Sheets 'ì›¹ì— ê²Œì‹œ' .csv URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.">
        </div>
        <button id="load-button" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all mb-4 hidden">
            ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
        </button>

        <!-- ë£°ë › ê²°ê³¼ í‘œì‹œ -->
        <div id="result-display" class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center text-center p-4 mb-6 shadow-inner overflow-hidden">
            <span id="result-text" class="text-3xl font-bold text-gray-700 transition-all duration-300">
                ë¬´ì—‡ì„ ë¨¹ì„ê¹Œìš”?
            </span>
        </div>

        <!-- ë½‘ê¸° ë²„íŠ¼ -->
        <button id="pick-button" class="w-full bg-indigo-600 text-white text-2xl font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none"
                disabled>
            ì˜¤ëŠ˜ì˜ ë©”ë‰´ ë½‘ê¸°! ğŸ¥³
        </button>
        <p id="loading-text" class="text-center text-gray-500 mt-2 hidden">
            ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </p>
        <p id="error-text" class="text-center text-red-500 mt-2 hidden"></p>
        
        <!-- ë½‘íŒ ë©”ë‰´ ìƒì„¸ ì •ë³´ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
        <div id="result-details" class="mt-6 border-t pt-6 hidden">
            <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- ê°€ëŠ” ê¸¸/ìœ„ì¹˜ (ì´ë¯¸ì§€ë¡œ ë³€ê²½) -->
                <div id="location-info" class="hidden">
                    <p class="text-sm font-medium text-gray-500 mb-1">ìœ„ì¹˜/ê°€ëŠ” ê¸¸</p>
                    <img id="location-image" src="https://placehold.co/600x400/e2e8f0/94a3b8?text=Location" alt="ìœ„ì¹˜/ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€" class="w-full h-auto rounded-lg shadow-md aspect-video object-cover clickable-img" 
                         onerror="this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Location'; this.alt='ìœ„ì¹˜/ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€ ì—†ìŒ';">
                </div>
                
                <!-- ë©”ë‰´íŒ -->
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">ë©”ë‰´íŒ</p>
                    <img id="menu-image" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu" alt="ë©”ë‰´íŒ ì´ë¯¸ì§€" class="w-full h-auto rounded-lg shadow-md aspect-square object-cover clickable-img" 
                         onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu'; this.alt='ë©”ë‰´íŒ ì´ë¯¸ì§€ ì—†ìŒ';">
                </div>
                <!-- ìŒì‹ ì‚¬ì§„ -->
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">í›„ê¸°/ìŒì‹ ì‚¬ì§„</p>
                    <img id="food-image" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Food" alt="ìŒì‹ ì‚¬ì§„" class="w-full h-auto rounded-lg shadow-md aspect-square object-cover clickable-img"
                         onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Food'; this.alt='ìŒì‹ ì‚¬ì§„ ì—†ìŒ';">
                </div>
            </div>

            <!-- Review Section (hidden by default) -->
            <div id="review-section" class="mt-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-3">ğŸ’¬ ì´ ë©”ë‰´ ë¦¬ë·°</h3>
                <!-- Review Form -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="review-input" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="í•œ ì¤„ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...">
                    <button id="submit-review-button" class="flex-shrink-0 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                        ë“±ë¡
                    </button>
                </div>
                <!-- Review List -->
                <div id="review-list" class="space-y-3 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                    <!-- Reviews will be populated here -->
                    <p id="review-placeholder" class="text-gray-500 italic text-center">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

        </div>

        <!-- í•˜ë‹¨ í‘¸í„° (ì„¤ëª…ì„œ) -->
        <footer class="mt-8 text-center">
            <details class="text-sm text-gray-500 cursor-pointer">
                <summary>ì‚¬ìš© ë°©ë²• (í´ë¦­í•˜ì—¬ ì—´ê¸°)</summary>
                <div class="mt-2 text-left p-4 bg-gray-50 rounded-lg">
                    <p>ì´ í”„ë¡œê·¸ë¨ì€ Google Sheetsì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
                    <p class="font-bold mt-2">ì‹œíŠ¸ êµ¬ì¡° (ì´ 4ì—´):</p>
                    <ul class="list-disc list-inside">
                        <li>Aì—´: ì‹ë‹¹/ë©”ë‰´ ì´ë¦„ (í•„ìˆ˜)</li>
                        <li>Bì—´: ê°€ëŠ” ê¸¸/ìœ„ì¹˜ (ì´ë¯¸ì§€ URL)</li>
<li>Cì—´: ë©”ë‰´íŒ (ì´ë¯¸ì§€ URL)</li>
                        <li>Dì—´: ìŒì‹/í›„ê¸° ì‚¬ì§„ (ì´ë¯¸ì§€ URL)</li>
                    </ul>
                </div>
            </details>
        </footer>

    </div>

    <!-- Image Modal Lightbox -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300"
         style="backdrop-filter: blur(5px);">
        <div class="relative max-w-3xl max-h-full">
            <img id="modal-image-content" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="max-w-full max-h-[90vh] rounded-lg shadow-xl">
            <!-- ë‹«ê¸° ë²„íŠ¼ -->
            <button id="modal-close" 
                    class="absolute -top-3 -right-3 bg-white text-gray-700 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white">
                &times;
            </button>
        </div>
    </div>


    <!-- Firebase SDKs (v12.4.0) -->
    <script type="module">
        // Firebase SDKs - v12.4.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp,
            setLogLevel // for debugging
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const sheetUrlInput = document.getElementById('sheet-url');
        const loadButton = document.getElementById('load-button');
        const pickButton = document.getElementById('pick-button');
        const resultText = document.getElementById('result-text');
        const loadingText = document.getElementById('loading-text');
        const errorText = document.getElementById('error-text');
        const resultDetails = document.getElementById('result-details');
        const locationInfo = document.getElementById('location-info');
        const locationImage = document.getElementById('location-image');
        const menuImage = document.getElementById('menu-image');
        const foodImage = document.getElementById('food-image');
        
        // Modal elements
        const imageModal = document.getElementById('image-modal');
        const modalImageContent = document.getElementById('modal-image-content');
        const modalClose = document.getElementById('modal-close');

        // Review elements
        const reviewSection = document.getElementById('review-section');
        const reviewInput = document.getElementById('review-input');
        const submitReviewButton = document.getElementById('submit-review-button');
        const reviewList = document.getElementById('review-list');
        const reviewPlaceholder = document.getElementById('review-placeholder');

        // ì „ì—­ ë³€ìˆ˜
        let menuList = [];
        let isSpinning = false;

        // Firebase and Review variables
        let db, auth, appId, userId;
        let currentPickedItem = null;
        let currentReviewUnsubscribe = null; // í˜„ì¬ êµ¬ë…ì¤‘ì¸ ë¦¬ë·° ë¦¬ìŠ¤ë„ˆ

        // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ (GitHub Pagesìš©) ---
        async function initializeFirebase() {
            try {
                // [ì¤‘ìš”!] ì—¬ê¸°ì— 1ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ firebaseConfig ê°ì²´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
                // ì´ê²ƒì€ ì‚¬ìš©ìë‹˜ ê³ ìœ ì˜ 'ì—´ì‡ 'ì…ë‹ˆë‹¤.
                const firebaseConfig = {
                    apiKey: "AIzaSyBDyz1Ti1Oo8K44JHogdLKdGIQILTp2sgI",
                    authDomain: "my-lunch-roulette.firebaseapp.com",
                    projectId: "my-lunch-roulette",
                    storageBucket: "my-lunch-roulette.firebasestorage.app",
                    messagingSenderId: "72237589697",
                    appId: "1:72237589697:web:e2d66bd1a96da08d432040",
                    measurementId: "G-T6GEZC0GG8"
                };

                // [ì¤‘ìš”!] Firestore ë°ì´í„° ê²½ë¡œë¥¼ ìœ„í•œ ê³ ìœ  ì•± ID
                // (Firebase í”„ë¡œì íŠ¸ IDì™€ ë‹¬ë¼ë„ ë©ë‹ˆë‹¤. ìš°ë¦¬ ì•±ë¼ë¦¬ ë°ì´í„°ë¥¼ êµ¬ë¶„í•˜ëŠ” ìš©ë„)
                const appIdString = "my-lunch-roulette-app"; // ì´ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.


                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    errorText.textContent = "ë¦¬ë·° ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (Config ëˆ„ë½)";
                    errorText.classList.remove('hidden');
                    return;
                }
                
                appId = appIdString; // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”

                // [FIXED] ìµëª… ë¡œê·¸ì¸ ë° userId í• ë‹¹ íƒ€ì´ë° ë¬¸ì œ ìˆ˜ì •
                // GitHub Pagesì—ì„œëŠ” í•­ìƒ ìµëª… ë¡œê·¸ì¸ ì‚¬ìš©
                console.log("Attempting anonymous sign-in...");
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid; // ë¡œê·¸ì¸ ì„±ê³µ ì§í›„ userIdë¥¼ í™•ì‹¤í•˜ê²Œ í• ë‹¹
                
                console.log("Firebase initialized for GitHub Pages. User ID:", userId);
                
            } catch (err) {
                console.error("Firebase init error:", err);
                errorText.textContent = `ë¦¬ë·° ê¸°ëŠ¥ ì˜¤ë¥˜: ${err.message}`;
                errorText.classList.remove('hidden');
            }
        }

        // --- ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
        async function loadMenus() {
            const url = sheetUrlInput.value;
            if (!url) {
                errorText.textContent = 'Google Sheets URLì„ ì…ë ¥í•˜ì„¸ìš”.';
                errorText.classList.remove('hidden');
                return;
            }

            loadingText.classList.remove('hidden');
            errorText.classList.add('hidden');
            pickButton.disabled = true;

            try {
                // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const fetchUrl = `${url}&_t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                const csvText = await response.text();
                
                menuList = csvText.split('\n')
                    .map(row => row.trim())
                    .filter(row => row.length > 0)
                    .map(row => {
                        // CSV íŒŒì‹± ê°œì„ : ì‰¼í‘œê°€ í¬í•¨ëœ ë¬¸ìì—´ ì²˜ë¦¬ (ê¸°ë³¸ì ì¸ í˜•íƒœ)
                        // "ì´ë¦„,A",B,C,D -> ["ì´ë¦„,A", B, C, D]
                        // "ë”°ì˜´í‘œ"ë¡œ ë¬¶ì¸ í•„ë“œ ë‚´ì˜ ì‰¼í‘œëŠ” ë¬´ì‹œí•˜ëŠ” ê°„ë‹¨í•œ íŒŒì„œ
                        const parts = [];
                        let currentPart = '';
                        let inQuote = false;
                        for (let i = 0; i < row.length; i++) {
                            const char = row[i];
                            if (char === '"') {
                                inQuote = !inQuote;
                            } else if (char === ',' && !inQuote) {
                                parts.push(currentPart.trim().replace(/^"|"$/g, '')); // ì•ë’¤ ë”°ì˜´í‘œ ì œê±°
                                currentPart = '';
                            } else {
                                currentPart += char;
                            }
                        }
                        parts.push(currentPart.trim().replace(/^"|"$/g, '')); // ë§ˆì§€ë§‰ ë¶€ë¶„ ì¶”ê°€

                        return {
                            name: parts[0] || 'ì´ë¦„ ì—†ìŒ',
                            locationImg: parts[1] || '', // Bì—´: ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€
                            menuImg: parts[2] || '',     // Cì—´: ë©”ë‰´íŒ ì´ë¯¸ì§€
                            foodImg: parts[3] || ''      // Dì—´: ìŒì‹ ì´ë¯¸ì§€
                        };
                    })
                    .filter(item => item.name !== 'ì´ë¦„ ì—†ìŒ' && item.name.length > 0 && item.name !== 'ì‹ë‹¹/ë©”ë‰´ ì´ë¦„'); // í—¤ë”(A1) í–‰ ì œì™¸

                if (menuList.length === 0) {
                    throw new Error('ì‹œíŠ¸ì—ì„œ ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ Aì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. (A1 í—¤ë” ì œì™¸ 1ê°œ ì´ìƒ í•„ìš”)');
                }
                
                pickButton.disabled = false;
                resultText.textContent = "ë©”ë‰´ ì¤€ë¹„ ì™„ë£Œ!";

            } catch (error) {
                console.error('Error loading menus:', error);
                errorText.textContent = `ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                errorText.classList.remove('hidden');
            } finally {
                loadingText.classList.add('hidden');
            }
        }

        // --- ë©”ë‰´ ë½‘ê¸° í•¨ìˆ˜ ---
        function pickMenu() {
            if (isSpinning || menuList.length === 0) return;

            isSpinning = true;
            pickButton.disabled = true;
            resultDetails.classList.add('hidden'); // ì´ì „ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            reviewSection.classList.add('hidden'); // ì´ì „ ë¦¬ë·° ìˆ¨ê¸°ê¸°
            errorText.classList.add('hidden'); // ì´ì „ ì˜¤ë¥˜ ìˆ¨ê¸°ê¸°

            // ë£°ë › ì• ë‹ˆë©”ì´ì…˜
            resultText.classList.add('spinning');
            resultText.style.transform = 'scale(0.8)';
            
            let spinCount = 0;
            const spinInterval = setInterval(() => {
                spinCount++;
                const randomItem = menuList[Math.floor(Math.random() * menuList.length)];
                resultText.textContent = randomItem.name;
                
                // ìŠ¤í•€ ì‹œê°„ì„ 1.5ì´ˆ ~ 2.5ì´ˆ ì‚¬ì´ë¡œ ëœë¤í•˜ê²Œ ì¡°ì ˆ
                const randomSpinDuration = Math.random() * 10 + 15; // 15 ~ 25íšŒ (1.5ì´ˆ ~ 2.5ì´ˆ)
                
                if (spinCount > randomSpinDuration) {
                    clearInterval(spinInterval);
                    
                    // ìµœì¢… ë©”ë‰´ ì„ íƒ
                    const pickedItem = menuList[Math.floor(Math.random() * menuList.length)];
                    currentPickedItem = pickedItem; // í˜„ì¬ ë½‘íŒ ë©”ë‰´ ì €ì¥

                    resultText.textContent = pickedItem.name;
                    resultText.classList.remove('spinning');
                    resultText.classList.add('result-pop');
                    resultText.style.transform = 'scale(1)';

                    // ì• ë‹ˆë©”ì´ì…˜ ëë‚œ í›„ ìƒì„¸ ì •ë³´ í‘œì‹œ
                    setTimeout(() => {
                        updateResultDetails(pickedItem);
                        resultText.classList.remove('result-pop');
                        isSpinning = false;
                        pickButton.disabled = false;
                        
                        // ë¦¬ë·° ë¡œë“œ
                        if(db && userId) { // Firestoreì™€ userIdê°€ ëª¨ë‘ ì¤€ë¹„ë˜ì—ˆì„ ë•Œë§Œ
                            loadReviews(pickedItem.name);
                        } else {
                            console.warn("DB or UserID not ready, cannot load reviews.");
                            if (!db) errorText.textContent = "ë¦¬ë·° DBì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                            if (!userId) errorText.textContent = "ë¦¬ë·° ì‚¬ìš©ì ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                            errorText.classList.remove('hidden');
                        }
                    }, 500); // pop ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„
                }
            }, 100); // 100ms ë§ˆë‹¤ ì´ë¦„ ë³€ê²½
        }

        // --- ê²°ê³¼ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸ ---
        function updateResultDetails(item) {
            // Bì—´: ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€
            if (item.locationImg && item.locationImg.startsWith('http')) {
                locationImage.src = item.locationImg;
                locationInfo.classList.remove('hidden');
            } else {
                locationInfo.classList.add('hidden');
            }
            // Cì—´: ë©”ë‰´íŒ ì´ë¯¸ì§€
            menuImage.src = (item.menuImg && item.menuImg.startsWith('http')) ? item.menuImg : 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu';
            // Dì—´: ìŒì‹ ì´ë¯¸ì§€
            foodImage.src = (item.foodImg && item.foodImg.startsWith('http')) ? item.foodImg : 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Food';

            resultDetails.classList.remove('hidden');
        }

        // --- ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° (Firestore onSnapshot) ---
        function loadReviews(restaurantName) {
            if (!db || !appId) {
                console.error("Firestore DB or AppID is not initialized.");
                return;
            }

            // ê¸°ì¡´ì— êµ¬ë…ì¤‘ì¸ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ (ë‹¤ë¥¸ ë©”ë‰´ë¥¼ ë½‘ì•˜ì„ ê²½ìš°)
            if (currentReviewUnsubscribe) {
                currentReviewUnsubscribe();
            }

            reviewSection.classList.remove('hidden');
            reviewList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
            reviewPlaceholder.textContent = 'ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            reviewPlaceholder.classList.remove('hidden');
            errorText.classList.add('hidden'); // ë¦¬ë·° ë¡œë“œ ì‹œì‘ ì‹œ ì˜¤ë¥˜ ìˆ¨ê¸°ê¸°

            // Firestore ê²½ë¡œ ìƒì„± (ë©”ë‰´ ì´ë¦„ì— íŠ¹ìˆ˜ë¬¸ì(./)ê°€ ìˆìœ¼ë©´ ê²½ë¡œë¡œ ì¸ì‹ë˜ë¯€ë¡œ ì¹˜í™˜)
            const safeRestaurantName = restaurantName.replace(/[.\/]/g, '_'); // . ì´ë‚˜ / ë¥¼ _ë¡œ ë³€ê²½
            const collectionPath = `artifacts/${appId}/public/data/lunch-reviews/${safeRestaurantName}/reviews`;
            const reviewsCollection = collection(db, collectionPath);
            
            // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ì¿¼ë¦¬ (ìµœì‹ ìˆœ)
            const q = query(reviewsCollection, orderBy("timestamp", "desc"));

            console.log(`Listening for reviews at: ${collectionPath}`);

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ êµ¬ë…
            currentReviewUnsubscribe = onSnapshot(q, (snapshot) => {
                reviewList.innerHTML = ''; // ëª©ë¡ ë‹¤ì‹œ ë¹„ìš°ê¸°
                if (snapshot.empty) {
                    reviewPlaceholder.textContent = 'ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!';
                    reviewPlaceholder.classList.remove('hidden');
                } else {
                    reviewPlaceholder.classList.add('hidden');
                    snapshot.forEach((doc) => {
                        const review = doc.data();
                        const reviewEl = document.createElement('div');
                        reviewEl.className = 'bg-white p-3 rounded-md shadow-sm border border-gray-200';
                        
                        const textEl = document.createElement('p');
                        textEl.textContent = review.text;
                        textEl.className = 'text-gray-800 break-words'; // ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ
                        reviewEl.appendChild(textEl);

                        if (review.timestamp) {
                            const dateEl = document.createElement('p');
                            dateEl.textContent = new Date(review.timestamp.seconds * 1000).toLocaleString('ko-KR', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                            dateEl.className = 'text-xs text-gray-400 mt-1 text-right';
                            reviewEl.appendChild(dateEl);
                        }
                        reviewList.appendChild(reviewEl);
                    });
                }
            }, (error) => {
                console.error("Error fetching reviews: ", error);
                // Firestore ìƒ‰ì¸ ì˜¤ë¥˜ ê°ì§€
                if (error.code === 'failed-precondition') {
                     reviewPlaceholder.textContent = 'ë¦¬ë·° ë¡œë”© ì˜¤ë¥˜ (ìƒ‰ì¸ í•„ìš”). ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.';
                     console.error("FIRESTORE ERROR: ", error.message);
                     console.log("Firestore ìƒ‰ì¸ ìë™ ìƒì„± ë§í¬ (ìœ„ ë©”ì‹œì§€ì˜ URLì„ í´ë¦­í•˜ì„¸ìš”):");
                } else {
                    reviewPlaceholder.textContent = 'ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
                reviewPlaceholder.classList.remove('hidden');
            });
        }

        // --- ë¦¬ë·° ì œì¶œ í•¨ìˆ˜ (Firestore addDoc) ---
        async function submitReview() {
            // [FIXED] userIdê°€ í™•ì‹¤íˆ ìˆëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸
            if (!db || !appId || !currentPickedItem || !userId) {
                console.error("Review submission failed. Missing critical data.", { db, appId, currentPickedItem, userId });
                errorText.textContent = `ë¦¬ë·° ë“±ë¡ ì˜¤ë¥˜: ì‚¬ìš©ì ì¸ì¦(userId)ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.`;
                errorText.classList.remove('hidden');
                return;
            }

            const reviewText = reviewInput.value.trim();
            if (reviewText.length === 0) {
                reviewInput.classList.add('border-red-500', 'animate-shake');
                reviewInput.placeholder = "ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!";
                setTimeout(() => {
                    reviewInput.classList.remove('border-red-500', 'animate-shake');
                    reviewInput.placeholder = "í•œ ì¤„ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...";
                }, 1000);
                return;
            }

            submitReviewButton.disabled = true;
            submitReviewButton.textContent = "ë“±ë¡ì¤‘...";
            errorText.classList.add('hidden'); // ì´ì „ ì˜¤ë¥˜ ìˆ¨ê¸°ê¸°

            try {
                const safeRestaurantName = currentPickedItem.name.replace(/[.\/]/g, '_');
                const collectionPath = `artifacts/${appId}/public/data/lunch-reviews/${safeRestaurantName}/reviews`;
                
                await addDoc(collection(db, collectionPath), {
                    text: reviewText,
                    author: userId, // [FIXED] ì´ì œ userIdê°€ í™•ì‹¤íˆ ë³´ì¥ë¨
                    timestamp: serverTimestamp() // ì„œë²„ ì‹œê°„ ê¸°ì¤€ íƒ€ì„ìŠ¤íƒ¬í”„
                });

                reviewInput.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°

            } catch (error) {
                console.error("Error adding review: ", error);
                errorText.textContent = `ë¦¬ë·° ë“±ë¡ ì˜¤ë¥˜: ${error.message}`;
                errorText.classList.remove('hidden');
            } finally {
                submitReviewButton.disabled = false;
                submitReviewButton.textContent = "ë“±ë¡";
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        function setupEventListeners() {
            loadButton.addEventListener('click', loadMenus);
            pickButton.addEventListener('click', pickMenu);

            // Modal functionality
            function openModal(src) {
                if (src && !src.includes('placehold.co') && src.startsWith('http')) { 
                    modalImageContent.src = src;
                    imageModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeModal() {
                imageModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                modalImageContent.src = '';
            }

            locationImage.addEventListener('click', () => openModal(locationImage.src));
            menuImage.addEventListener('click', () => openModal(menuImage.src));
            foodImage.addEventListener('click', () => openModal(foodImage.src));

            modalClose.addEventListener('click', closeModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    closeModal();
                }
            });

            // Review submit listener
            submitReviewButton.addEventListener('click', submitReview);
            reviewInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Form submit ë°©ì§€
                    submitReview();
                }
            });
        }

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        window.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM ë¡œë“œ ì™„ë£Œ. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘.");

            // Firebase ì´ˆê¸°í™” (GitHub Pagesìš©)
            await initializeFirebase();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // í•˜ë“œì½”ë”©ëœ URL ì„¤ì • ë° ìë™ ë¡œë“œ
            const hardcodedUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSHqg-V9dLAbA_a30oHi1d7fF6UdyuDnIDu7yrJfC9kXuJnu2ow0ZeuSkdkGeZ1reVi878U27s4Hll3/pub?output=csv";
            sheetUrlInput.value = hardcodedUrl;
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
            if (hardcodedUrl) {
                await loadMenus();
            }
        });

    </script>
</body>
</html>

