<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ì ì‹¬ ë£°ë ›</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans KR í°íŠ¸ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš© */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* ë£°ë › ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í‚¤í”„ë ˆì„ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(3600deg); } /* 10ë°”í€´ */
        }
        .spinning {
            animation: spin 3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }
        /* ê²°ê³¼ íŒì—… ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-pop {
            animation: pop 0.5s ease-out forwards;
        }
        /* Clickable images */
        .clickable-img {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .clickable-img:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-xl rounded-2xl shadow-xl p-6 md:p-8">
        
        <!-- í—¤ë” -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">ì˜¤ëŠ˜ ë­ ë¨¹ì§€? ğŸ˜‹</h1>
            <p class="text-gray-500 mt-2">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ì‹¬ ë©”ë‰´ë¥¼ ë½‘ì•„ë³´ì„¸ìš”!</p>
        </header>

        <!-- URL ì…ë ¥ì°½ (í˜„ì¬ í•˜ë“œì½”ë”©ìœ¼ë¡œ ìˆ¨ê¹€) -->
        <div class="mb-4 hidden">
            <label for="sheet-url" class="block text-sm font-medium text-gray-700 mb-1">Google Sheets CSV URL</label>
            <input type="text" id="sheet-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="Google Sheets 'ì›¹ì— ê²Œì‹œ' .csv URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.">
        </div>
        <button id="load-button" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all mb-4 hidden">
            ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
        </button>

        <!-- ë£°ë › ê²°ê³¼ í‘œì‹œ -->
        <div id="result-display" class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center text-center p-4 mb-6 shadow-inner overflow-hidden">
            <span id="result-text" class="text-3xl font-bold text-gray-700 transition-all duration-300">
                ë¬´ì—‡ì„ ë¨¹ì„ê¹Œìš”?
            </span>
        </div>

        <!-- ë½‘ê¸° ë²„íŠ¼ -->
        <button id="pick-button" class="w-full bg-indigo-600 text-white text-2xl font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none"
                disabled>
            ì˜¤ëŠ˜ì˜ ë©”ë‰´ ë½‘ê¸°! ğŸ¥³
        </button>
        <p id="loading-text" class="text-center text-gray-500 mt-2 hidden">
            ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
        </p>
        <p id="error-text" class="text-center text-red-500 mt-2 hidden"></p>
        
        <!-- ë½‘íŒ ë©”ë‰´ ìƒì„¸ ì •ë³´ (ìˆ¨ê²¨ì ¸ ìˆìŒ) -->
        <div id="result-details" class="mt-6 border-t pt-6 hidden">
            <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- ê°€ëŠ” ê¸¸/ìœ„ì¹˜ (ì´ë¯¸ì§€ë¡œ ë³€ê²½) -->
                <div id="location-info" class="hidden">
                    <p class="text-sm font-medium text-gray-500 mb-1">ìœ„ì¹˜/ê°€ëŠ” ê¸¸</p>
                    <img id="location-image" src="https://placehold.co/600x400/e2e8f0/94a3b8?text=Location" alt="ìœ„ì¹˜/ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€" class="w-full h-auto rounded-lg shadow-md aspect-video object-cover clickable-img" 
                         onerror="this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Location'; this.alt='ìœ„ì¹˜/ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€ ì—†ìŒ';">
                </div>
                
                <!-- ë©”ë‰´íŒ -->
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">ë©”ë‰´íŒ</p>
                    <img id="menu-image" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu" alt="ë©”ë‰´íŒ ì´ë¯¸ì§€" class="w-full h-auto rounded-lg shadow-md aspect-square object-cover clickable-img" 
                         onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu'; this.alt='ë©”ë‰´íŒ ì´ë¯¸ì§€ ì—†ìŒ';">
                </div>
                <!-- ìŒì‹ ì‚¬ì§„ -->
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">í›„ê¸°/ìŒì‹ ì‚¬ì§„</p>
                    <img id="food-image" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Food" alt="ìŒì‹ ì‚¬ì§„" class="w-full h-auto rounded-lg shadow-md aspect-square object-cover clickable-img"
                         onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Food'; this.alt='ìŒì‹ ì‚¬ì§„ ì—†ìŒ';">
                </div>
            </div>

            <!-- [NEW] Review Section (hidden by default) -->
            <div id="review-section" class="mt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3">ğŸ’¬ ì´ ë©”ë‰´ ë¦¬ë·°</h3>
                <!-- Review Form -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="review-input" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="í•œ ì¤„ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...">
                    <button id="submit-review-button" class="flex-shrink-0 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                        ë“±ë¡
                    </button>
                </div>
                <!-- Review List -->
                <div id="review-list" class="space-y-3 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                    <!-- Reviews will be populated here -->
                    <p id="review-placeholder" class="text-gray-500 italic text-center">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

        </div>

        <!-- í•˜ë‹¨ í‘¸í„° (ì„¤ëª…ì„œ) -->
        <footer class="mt-8 text-center">
            <details class="text-sm text-gray-500 cursor-pointer">
                <summary>ì‚¬ìš© ë°©ë²• (í´ë¦­í•˜ì—¬ ì—´ê¸°)</summary>
                <div class="mt-2 text-left p-4 bg-gray-50 rounded-lg">
                    <p>ì´ í”„ë¡œê·¸ë¨ì€ Google Sheetsì™€ ì—°ë™ë©ë‹ˆë‹¤.</p>
                    <p class="font-bold mt-2">ì‹œíŠ¸ êµ¬ì¡° (ì´ 4ì—´):</p>
                    <ul class="list-disc list-inside">
                        <li>Aì—´: ì‹ë‹¹/ë©”ë‰´ ì´ë¦„ (í•„ìˆ˜)</li>
                        <li>Bì—´: ê°€ëŠ” ê¸¸/ìœ„ì¹˜ (ì´ë¯¸ì§€ URL)</li>
                        <li>Cì—´: ë©”ë‰´íŒ (ì´ë¯¸ì§€ URL)</li>
                        <li>Dì—´: ìŒì‹/í›„ê¸° ì‚¬ì§„ (ì´ë¯¸ì§€ URL)</li>
                    </ul>
                </div>
            </details>
        </footer>

    </div>

    <!-- Image Modal Lightbox -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300"
         style="backdrop-filter: blur(5px);">
        <div class="relative max-w-3xl max-h-full">
            <img id="modal-image-content" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="max-w-full max-h-[90vh] rounded-lg shadow-xl">
            <!-- ë‹«ê¸° ë²„íŠ¼ -->
            <button id="modal-close" 
                    class="absolute -top-3 -right-3 bg-white text-gray-700 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white">
                &times;
            </button>
        </div>
    </div>


    <!-- [NEW] Firebase SDKs -->
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp,
            setLogLevel // for debugging
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const sheetUrlInput = document.getElementById('sheet-url');
        const loadButton = document.getElementById('load-button');
        const pickButton = document.getElementById('pick-button');
        const resultText = document.getElementById('result-text');
        const loadingText = document.getElementById('loading-text');
        const errorText = document.getElementById('error-text');
        const resultDetails = document.getElementById('result-details');
        const locationInfo = document.getElementById('location-info');
        const locationImage = document.getElementById('location-image');
        const menuImage = document.getElementById('menu-image');
        const foodImage = document.getElementById('food-image');
        
        // Modal elements
        const imageModal = document.getElementById('image-modal');
        const modalImageContent = document.getElementById('modal-image-content');
        const modalClose = document.getElementById('modal-close');

        // [NEW] Review elements
        const reviewSection = document.getElementById('review-section');
        const reviewInput = document.getElementById('review-input');
        const submitReviewButton = document.getElementById('submit-review-button');
        const reviewList = document.getElementById('review-list');
        const reviewPlaceholder = document.getElementById('review-placeholder');

        // ì „ì—­ ë³€ìˆ˜
        let menuList = [];
        let isSpinning = false;

        // [NEW] Firebase and Review variables
        let db, auth, appId, userId;
        let currentPickedItem = null;
        let currentReviewUnsubscribe = null; // í˜„ì¬ êµ¬ë…ì¤‘ì¸ ë¦¬ë·° ë¦¬ìŠ¤ë„ˆ

        // --- [NEW] Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---
        async function initializeFirebase() {
            try {
                // __firebase_configì™€ __app_idëŠ” ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-lunch-app';

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    errorText.textContent = "ë¦¬ë·° ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    errorText.classList.remove('hidden');
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”

                // ì¸ì¦ (ì»¤ìŠ¤í…€ í† í° ë˜ëŠ” ìµëª…)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || `anon-${Math.random().toString(36).substr(2, 9)}`;
                console.log("Firebase initialized. User ID:", userId);
                
            } catch (err) {
                console.error("Firebase init error:", err);
                errorText.textContent = `ë¦¬ë·° ê¸°ëŠ¥ ì˜¤ë¥˜: ${err.message}`;
                errorText.classList.remove('hidden');
            }
        }

        // --- ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ ---
        async function loadMenus() {
            const url = sheetUrlInput.value;
            if (!url) {
                errorText.textContent = 'Google Sheets URLì„ ì…ë ¥í•˜ì„¸ìš”.';
                errorText.classList.remove('hidden');
                return;
            }

            loadingText.classList.remove('hidden');
            errorText.classList.add('hidden');
            pickButton.disabled = true;

            try {
                // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                const fetchUrl = `${url}&_t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                const csvText = await response.text();
                
                menuList = csvText.split('\n')
                    .map(row => row.trim())
                    .filter(row => row.length > 0)
                    .map(row => {
                        const parts = row.split(','); // ê°„ë‹¨í•œ ì‰¼í‘œ êµ¬ë¶„
                        return {
                            name: parts[0] || 'ì´ë¦„ ì—†ìŒ',
                            locationImg: parts[1] || '', // Bì—´: ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€
                            menuImg: parts[2] || '',     // Cì—´: ë©”ë‰´íŒ ì´ë¯¸ì§€
                            foodImg: parts[3] || ''      // Dì—´: ìŒì‹ ì´ë¯¸ì§€
                        };
                    })
                    .filter(item => item.name !== 'ì´ë¦„ ì—†ìŒ' && item.name.length > 0); // ì´ë¦„ì´ ìˆëŠ” ë©”ë‰´ë§Œ í•„í„°ë§

                if (menuList.length === 0) {
                    throw new Error('ì‹œíŠ¸ì—ì„œ ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ Aì—´ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
                
                pickButton.disabled = false;
                resultText.textContent = "ë©”ë‰´ ì¤€ë¹„ ì™„ë£Œ!";

            } catch (error) {
                console.error('Error loading menus:', error);
                errorText.textContent = `ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                errorText.classList.remove('hidden');
            } finally {
                loadingText.classList.add('hidden');
            }
        }

        // --- ë©”ë‰´ ë½‘ê¸° í•¨ìˆ˜ ---
        function pickMenu() {
            if (isSpinning || menuList.length === 0) return;

            isSpinning = true;
            pickButton.disabled = true;
            resultDetails.classList.add('hidden'); // ì´ì „ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            reviewSection.classList.add('hidden'); // [NEW] ì´ì „ ë¦¬ë·° ìˆ¨ê¸°ê¸°

            // ë£°ë › ì• ë‹ˆë©”ì´ì…˜
            resultText.classList.add('spinning');
            resultText.style.transform = 'scale(0.8)';
            
            let spinCount = 0;
            const spinInterval = setInterval(() => {
                spinCount++;
                const randomItem = menuList[Math.floor(Math.random() * menuList.length)];
                resultText.textContent = randomItem.name;
                
                if (spinCount > 20) { // ì•½ 2ì´ˆê°„ ìŠ¤í•€ (20 * 100ms)
                    clearInterval(spinInterval);
                    
                    // ìµœì¢… ë©”ë‰´ ì„ íƒ
                    const pickedItem = menuList[Math.floor(Math.random() * menuList.length)];
                    currentPickedItem = pickedItem; // [NEW] í˜„ì¬ ë½‘íŒ ë©”ë‰´ ì €ì¥

                    resultText.textContent = pickedItem.name;
                    resultText.classList.remove('spinning');
                    resultText.classList.add('result-pop');
                    resultText.style.transform = 'scale(1)';

                    // ì• ë‹ˆë©”ì´ì…˜ ëë‚œ í›„ ìƒì„¸ ì •ë³´ í‘œì‹œ
                    setTimeout(() => {
                        updateResultDetails(pickedItem);
                        resultText.classList.remove('result-pop');
                        isSpinning = false;
                        pickButton.disabled = false;
                        
                        // [NEW] ë¦¬ë·° ë¡œë“œ
                        if(db) { // Firestoreê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆì„ ë•Œë§Œ
                            loadReviews(pickedItem.name);
                        }
                    }, 500); // pop ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„
                }
            }, 100); // 100ms ë§ˆë‹¤ ì´ë¦„ ë³€ê²½
        }

        // --- ê²°ê³¼ ìƒì„¸ ì •ë³´ ì—…ë°ì´íŠ¸ ---
        function updateResultDetails(item) {
            // Bì—´: ê°€ëŠ” ê¸¸ ì´ë¯¸ì§€
            if (item.locationImg) {
                locationImage.src = item.locationImg;
                locationInfo.classList.remove('hidden');
            } else {
                locationInfo.classList.add('hidden');
            }
            // Cì—´: ë©”ë‰´íŒ ì´ë¯¸ì§€
            menuImage.src = item.menuImg || 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu';
            // Dì—´: ìŒì‹ ì´ë¯¸ì§€
            foodImage.src = item.foodImg || 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Food';

            resultDetails.classList.remove('hidden');
        }

        // [NEW] --- ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° (Firestore onSnapshot) ---
        function loadReviews(restaurantName) {
            if (!db || !appId) return;

            // ê¸°ì¡´ì— êµ¬ë…ì¤‘ì¸ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ (ë‹¤ë¥¸ ë©”ë‰´ë¥¼ ë½‘ì•˜ì„ ê²½ìš°)
            if (currentReviewUnsubscribe) {
                currentReviewUnsubscribe();
            }

            reviewSection.classList.remove('hidden');
            reviewList.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
            reviewPlaceholder.textContent = 'ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            reviewPlaceholder.classList.remove('hidden');

            // Firestore ê²½ë¡œ ìƒì„±
            // Aì—´ì˜ ì‹ë‹¹/ë©”ë‰´ ì´ë¦„ì„ IDë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const collectionPath = `artifacts/${appId}/public/data/lunch-reviews/${restaurantName}/reviews`;
            const reviewsCollection = collection(db, collectionPath);
            
            // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ ì¿¼ë¦¬ (ìµœì‹ ìˆœ)
            // ì°¸ê³ : FirestoreëŠ” ê¸°ë³¸ì ìœ¼ë¡œ orderByë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ìƒ‰ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” 'timestamp' í•„ë“œì— ëŒ€í•œ ë‹¨ì¼ ìƒ‰ì¸ì„ ê°€ì •í•©ë‹ˆë‹¤.
            // ë§Œì•½ ìƒ‰ì¸ ì˜¤ë¥˜ê°€ ì½˜ì†”ì— ë‚˜íƒ€ë‚˜ë©´, orderByë¥¼ ì œê±°í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬í•´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            const q = query(reviewsCollection, orderBy("timestamp", "desc"));

            console.log(`Listening for reviews at: ${collectionPath}`);

            // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ êµ¬ë…
            currentReviewUnsubscribe = onSnapshot(q, (snapshot) => {
                reviewList.innerHTML = ''; // ëª©ë¡ ë‹¤ì‹œ ë¹„ìš°ê¸°
                if (snapshot.empty) {
                    reviewPlaceholder.textContent = 'ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!';
                    reviewPlaceholder.classList.remove('hidden');
                } else {
                    reviewPlaceholder.classList.add('hidden');
                    snapshot.forEach((doc) => {
                        const review = doc.data();
                        const reviewEl = document.createElement('div');
                        reviewEl.className = 'bg-white p-3 rounded-md shadow-sm border border-gray-200';
                        
                        const textEl = document.createElement('p');
                        textEl.textContent = review.text;
                        textEl.className = 'text-gray-800';
                        reviewEl.appendChild(textEl);

                        if (review.timestamp) {
                            const dateEl = document.createElement('p');
                            dateEl.textContent = new Date(review.timestamp.seconds * 1000).toLocaleString('ko-KR');
                            dateEl.className = 'text-xs text-gray-400 mt-1 text-right';
                            reviewEl.appendChild(dateEl);
                        }
                        reviewList.appendChild(reviewEl);
                    });
                }
            }, (error) => {
                console.error("Error fetching reviews: ", error);
                reviewPlaceholder.textContent = 'ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                reviewPlaceholder.classList.remove('hidden');
            });
        }

        // [NEW] --- ë¦¬ë·° ì œì¶œ í•¨ìˆ˜ (Firestore addDoc) ---
        async function submitReview() {
            if (!db || !appId || !currentPickedItem) return;

            const reviewText = reviewInput.value.trim();
            if (reviewText.length === 0) {
                // alert() ëŒ€ì‹  UI í”¼ë“œë°± (ì˜ˆ: input í”ë“¤ê¸° ë˜ëŠ” ë©”ì‹œì§€ í‘œì‹œ)
                reviewInput.classList.add('border-red-500', 'animate-shake');
                reviewInput.placeholder = "ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!";
                setTimeout(() => {
                    reviewInput.classList.remove('border-red-500', 'animate-shake');
                    reviewInput.placeholder = "í•œ ì¤„ ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”...";
                }, 1000);
                return;
            }

            submitReviewButton.disabled = true;
            submitReviewButton.textContent = "ë“±ë¡ì¤‘...";

            try {
                const restaurantName = currentPickedItem.name;
                const collectionPath = `artifacts/${appId}/public/data/lunch-reviews/${restaurantName}/reviews`;
                
                await addDoc(collection(db, collectionPath), {
                    text: reviewText,
                    author: userId, // ìµëª… ID ë˜ëŠ” ì‚¬ìš©ì ID
                    timestamp: serverTimestamp() // ì„œë²„ ì‹œê°„ ê¸°ì¤€ íƒ€ì„ìŠ¤íƒ¬í”„
                });

                reviewInput.value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°

            } catch (error) {
                console.error("Error adding review: ", error);
                // alert() ëŒ€ì‹  errorText ì‚¬ìš©
                errorText.textContent = `ë¦¬ë·° ë“±ë¡ ì˜¤ë¥˜: ${error.message}`;
                errorText.classList.remove('hidden');
            } finally {
                submitReviewButton.disabled = false;
                submitReviewButton.textContent = "ë“±ë¡";
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        function setupEventListeners() {
            loadButton.addEventListener('click', loadMenus);
            pickButton.addEventListener('click', pickMenu);

            // Modal functionality
            function openModal(src) {
                if (src && !src.includes('placehold.co')) { 
                    modalImageContent.src = src;
                    imageModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeModal() {
                imageModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                modalImageContent.src = '';
            }

            locationImage.addEventListener('click', () => openModal(locationImage.src));
            menuImage.addEventListener('click', () => openModal(menuImage.src));
            foodImage.addEventListener('click', () => openModal(foodImage.src));

            modalClose.addEventListener('click', closeModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    closeModal();
                }
            });

            // [NEW] Review submit listener
            submitReviewButton.addEventListener('click', submitReview);
            reviewInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitReview();
                }
            });
        }

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        // DOMì´ ë¡œë“œëœ í›„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM ë¡œë“œ ì™„ë£Œ. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘.");

            // [NEW] Firebase ì´ˆê¸°í™”
            await initializeFirebase();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupEventListeners();
            
            // í•˜ë“œì½”ë”©ëœ URL ì„¤ì • ë° ìë™ ë¡œë“œ
            const hardcodedUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSHqg-V9dLAbA_a30oHi1d7fF6UdyuDnIDu7yrJfC9kXuJnu2ow0ZeuSkdkGeZ1reVi878U27s4Hll3/pub?output=csv";
            sheetUrlInput.value = hardcodedUrl;
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë©”ë‰´ ë¶ˆëŸ¬ì˜¤ê¸°
            if (hardcodedUrl) {
                await loadMenus();
            }
        });

    </script>
</body>
</html>

