<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘 뭐 먹지? 점심 룰렛</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Noto Sans KR 폰트를 기본으로 사용 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        /* 룰렛 애니메이션을 위한 키프레임 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(3600deg); } /* 10바퀴 */
        }
        .spinning {
            animation: spin 3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }
        /* 결과 팝업 애니메이션 */
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .result-pop {
            animation: pop 0.5s ease-out forwards;
        }
        /* Clickable images */
        .clickable-img {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .clickable-img:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-xl rounded-2xl shadow-xl p-6 md:p-8">
        
        <!-- 헤더 -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">오늘 뭐 먹지? 😋</h1>
            <p class="text-gray-500 mt-2">버튼을 눌러 점심 메뉴를 뽑아보세요!</p>
        </header>

        <!-- URL 입력창 (현재 하드코딩으로 숨김) -->
        <div class="mb-4 hidden">
            <label for="sheet-url" class="block text-sm font-medium text-gray-700 mb-1">Google Sheets CSV URL</label>
            <input type="text" id="sheet-url" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                   placeholder="Google Sheets '웹에 게시' .csv URL을 붙여넣으세요.">
        </div>
        <button id="load-button" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all mb-4 hidden">
            메뉴 불러오기
        </button>

        <!-- 룰렛 결과 표시 -->
        <div id="result-display" class="w-full h-48 bg-gray-100 rounded-lg flex items-center justify-center text-center p-4 mb-6 shadow-inner overflow-hidden">
            <span id="result-text" class="text-3xl font-bold text-gray-700 transition-all duration-300">
                무엇을 먹을까요?
            </span>
        </div>

        <!-- 뽑기 버튼 -->
        <button id="pick-button" class="w-full bg-indigo-600 text-white text-2xl font-bold py-4 px-6 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none disabled:transform-none"
                disabled>
            오늘의 메뉴 뽑기! 🥳
        </button>
        <p id="loading-text" class="text-center text-gray-500 mt-2 hidden">
            메뉴를 불러오는 중입니다...
        </p>
        <p id="error-text" class="text-center text-red-500 mt-2 hidden"></p>
        
        <!-- 뽑힌 메뉴 상세 정보 (숨겨져 있음) -->
        <div id="result-details" class="mt-6 border-t pt-6 hidden">
            <!-- 이미지 갤러리 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 가는 길/위치 (이미지로 변경) -->
                <div id="location-info" class="hidden">
                    <p class="text-sm font-medium text-gray-500 mb-1">위치/가는 길</p>
                    <img id="location-image" src="https://placehold.co/600x400/e2e8f0/94a3b8?text=Location" alt="위치/가는 길 이미지" class="w-full h-auto rounded-lg shadow-md aspect-video object-cover clickable-img" 
                         onerror="this.src='https://placehold.co/600x400/e2e8f0/94a3b8?text=Location'; this.alt='위치/가는 길 이미지 없음';">
                </div>
                
                <!-- 메뉴판 -->
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">메뉴판</p>
                    <img id="menu-image" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu" alt="메뉴판 이미지" class="w-full h-auto rounded-lg shadow-md aspect-square object-cover clickable-img" 
                         onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu'; this.alt='메뉴판 이미지 없음';">
                </div>
                <!-- 음식 사진 -->
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-1">후기/음식 사진</p>
                    <img id="food-image" src="https://placehold.co/300x300/e2e8f0/94a3b8?text=Food" alt="음식 사진" class="w-full h-auto rounded-lg shadow-md aspect-square object-cover clickable-img"
                         onerror="this.src='https://placehold.co/300x300/e2e8f0/94a3b8?text=Food'; this.alt='음식 사진 없음';">
                </div>
            </div>

            <!-- [NEW] Review Section (hidden by default) -->
            <div id="review-section" class="mt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3">💬 이 메뉴 리뷰</h3>
                <!-- Review Form -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="review-input" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="한 줄 리뷰를 남겨주세요...">
                    <button id="submit-review-button" class="flex-shrink-0 bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all">
                        등록
                    </button>
                </div>
                <!-- Review List -->
                <div id="review-list" class="space-y-3 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                    <!-- Reviews will be populated here -->
                    <p id="review-placeholder" class="text-gray-500 italic text-center">리뷰를 불러오는 중...</p>
                </div>
            </div>

        </div>

        <!-- 하단 푸터 (설명서) -->
        <footer class="mt-8 text-center">
            <details class="text-sm text-gray-500 cursor-pointer">
                <summary>사용 방법 (클릭하여 열기)</summary>
                <div class="mt-2 text-left p-4 bg-gray-50 rounded-lg">
                    <p>이 프로그램은 Google Sheets와 연동됩니다.</p>
                    <p class="font-bold mt-2">시트 구조 (총 4열):</p>
                    <ul class="list-disc list-inside">
                        <li>A열: 식당/메뉴 이름 (필수)</li>
                        <li>B열: 가는 길/위치 (이미지 URL)</li>
                        <li>C열: 메뉴판 (이미지 URL)</li>
                        <li>D열: 음식/후기 사진 (이미지 URL)</li>
                    </ul>
                </div>
            </details>
        </footer>

    </div>

    <!-- Image Modal Lightbox -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300"
         style="backdrop-filter: blur(5px);">
        <div class="relative max-w-3xl max-h-full">
            <img id="modal-image-content" src="" alt="확대 이미지" class="max-w-full max-h-[90vh] rounded-lg shadow-xl">
            <!-- 닫기 버튼 -->
            <button id="modal-close" 
                    class="absolute -top-3 -right-3 bg-white text-gray-700 rounded-full w-10 h-10 flex items-center justify-center text-2xl font-bold shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-white">
                &times;
            </button>
        </div>
    </div>


    <!-- [NEW] Firebase SDKs -->
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy, 
            serverTimestamp,
            setLogLevel // for debugging
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM 요소 가져오기
        const sheetUrlInput = document.getElementById('sheet-url');
        const loadButton = document.getElementById('load-button');
        const pickButton = document.getElementById('pick-button');
        const resultText = document.getElementById('result-text');
        const loadingText = document.getElementById('loading-text');
        const errorText = document.getElementById('error-text');
        const resultDetails = document.getElementById('result-details');
        const locationInfo = document.getElementById('location-info');
        const locationImage = document.getElementById('location-image');
        const menuImage = document.getElementById('menu-image');
        const foodImage = document.getElementById('food-image');
        
        // Modal elements
        const imageModal = document.getElementById('image-modal');
        const modalImageContent = document.getElementById('modal-image-content');
        const modalClose = document.getElementById('modal-close');

        // [NEW] Review elements
        const reviewSection = document.getElementById('review-section');
        const reviewInput = document.getElementById('review-input');
        const submitReviewButton = document.getElementById('submit-review-button');
        const reviewList = document.getElementById('review-list');
        const reviewPlaceholder = document.getElementById('review-placeholder');

        // 전역 변수
        let menuList = [];
        let isSpinning = false;

        // [NEW] Firebase and Review variables
        let db, auth, appId, userId;
        let currentPickedItem = null;
        let currentReviewUnsubscribe = null; // 현재 구독중인 리뷰 리스너

        // --- [NEW] Firebase 초기화 및 인증 ---
        async function initializeFirebase() {
            try {
                // __firebase_config와 __app_id는 캔버스 환경에서 자동으로 제공됩니다.
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-lunch-app';

                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    errorText.textContent = "리뷰 기능을 초기화할 수 없습니다.";
                    errorText.classList.remove('hidden');
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // 디버그 로그 활성화

                // 인증 (커스텀 토큰 또는 익명)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || `anon-${Math.random().toString(36).substr(2, 9)}`;
                console.log("Firebase initialized. User ID:", userId);
                
            } catch (err) {
                console.error("Firebase init error:", err);
                errorText.textContent = `리뷰 기능 오류: ${err.message}`;
                errorText.classList.remove('hidden');
            }
        }

        // --- 메뉴 불러오기 함수 ---
        async function loadMenus() {
            const url = sheetUrlInput.value;
            if (!url) {
                errorText.textContent = 'Google Sheets URL을 입력하세요.';
                errorText.classList.remove('hidden');
                return;
            }

            loadingText.classList.remove('hidden');
            errorText.classList.add('hidden');
            pickButton.disabled = true;

            try {
                // 캐시 방지를 위해 타임스탬프 추가
                const fetchUrl = `${url}&_t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                if (!response.ok) {
                    throw new Error('네트워크 응답이 올바르지 않습니다.');
                }
                const csvText = await response.text();
                
                menuList = csvText.split('\n')
                    .map(row => row.trim())
                    .filter(row => row.length > 0)
                    .map(row => {
                        const parts = row.split(','); // 간단한 쉼표 구분
                        return {
                            name: parts[0] || '이름 없음',
                            locationImg: parts[1] || '', // B열: 가는 길 이미지
                            menuImg: parts[2] || '',     // C열: 메뉴판 이미지
                            foodImg: parts[3] || ''      // D열: 음식 이미지
                        };
                    })
                    .filter(item => item.name !== '이름 없음' && item.name.length > 0); // 이름이 있는 메뉴만 필터링

                if (menuList.length === 0) {
                    throw new Error('시트에서 메뉴를 찾을 수 없거나 A열이 비어있습니다.');
                }
                
                pickButton.disabled = false;
                resultText.textContent = "메뉴 준비 완료!";

            } catch (error) {
                console.error('Error loading menus:', error);
                errorText.textContent = `메뉴 로드 실패: ${error.message}`;
                errorText.classList.remove('hidden');
            } finally {
                loadingText.classList.add('hidden');
            }
        }

        // --- 메뉴 뽑기 함수 ---
        function pickMenu() {
            if (isSpinning || menuList.length === 0) return;

            isSpinning = true;
            pickButton.disabled = true;
            resultDetails.classList.add('hidden'); // 이전 결과 숨기기
            reviewSection.classList.add('hidden'); // [NEW] 이전 리뷰 숨기기

            // 룰렛 애니메이션
            resultText.classList.add('spinning');
            resultText.style.transform = 'scale(0.8)';
            
            let spinCount = 0;
            const spinInterval = setInterval(() => {
                spinCount++;
                const randomItem = menuList[Math.floor(Math.random() * menuList.length)];
                resultText.textContent = randomItem.name;
                
                if (spinCount > 20) { // 약 2초간 스핀 (20 * 100ms)
                    clearInterval(spinInterval);
                    
                    // 최종 메뉴 선택
                    const pickedItem = menuList[Math.floor(Math.random() * menuList.length)];
                    currentPickedItem = pickedItem; // [NEW] 현재 뽑힌 메뉴 저장

                    resultText.textContent = pickedItem.name;
                    resultText.classList.remove('spinning');
                    resultText.classList.add('result-pop');
                    resultText.style.transform = 'scale(1)';

                    // 애니메이션 끝난 후 상세 정보 표시
                    setTimeout(() => {
                        updateResultDetails(pickedItem);
                        resultText.classList.remove('result-pop');
                        isSpinning = false;
                        pickButton.disabled = false;
                        
                        // [NEW] 리뷰 로드
                        if(db) { // Firestore가 성공적으로 초기화되었을 때만
                            loadReviews(pickedItem.name);
                        }
                    }, 500); // pop 애니메이션 시간
                }
            }, 100); // 100ms 마다 이름 변경
        }

        // --- 결과 상세 정보 업데이트 ---
        function updateResultDetails(item) {
            // B열: 가는 길 이미지
            if (item.locationImg) {
                locationImage.src = item.locationImg;
                locationInfo.classList.remove('hidden');
            } else {
                locationInfo.classList.add('hidden');
            }
            // C열: 메뉴판 이미지
            menuImage.src = item.menuImg || 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Menu';
            // D열: 음식 이미지
            foodImage.src = item.foodImg || 'https://placehold.co/300x300/e2e8f0/94a3b8?text=Food';

            resultDetails.classList.remove('hidden');
        }

        // [NEW] --- 리뷰 불러오기 (Firestore onSnapshot) ---
        function loadReviews(restaurantName) {
            if (!db || !appId) return;

            // 기존에 구독중인 리스너가 있다면 해제 (다른 메뉴를 뽑았을 경우)
            if (currentReviewUnsubscribe) {
                currentReviewUnsubscribe();
            }

            reviewSection.classList.remove('hidden');
            reviewList.innerHTML = ''; // 기존 목록 비우기
            reviewPlaceholder.textContent = '리뷰를 불러오는 중...';
            reviewPlaceholder.classList.remove('hidden');

            // Firestore 경로 생성
            // A열의 식당/메뉴 이름을 ID로 사용합니다.
            const collectionPath = `artifacts/${appId}/public/data/lunch-reviews/${restaurantName}/reviews`;
            const reviewsCollection = collection(db, collectionPath);
            
            // 타임스탬프 기준으로 내림차순 정렬 쿼리 (최신순)
            // 참고: Firestore는 기본적으로 orderBy를 사용하려면 색인이 필요할 수 있습니다.
            // 여기서는 'timestamp' 필드에 대한 단일 색인을 가정합니다.
            // 만약 색인 오류가 콘솔에 나타나면, orderBy를 제거하고 클라이언트에서 정렬해야 할 수 있습니다.
            const q = query(reviewsCollection, orderBy("timestamp", "desc"));

            console.log(`Listening for reviews at: ${collectionPath}`);

            // 실시간 리스너 구독
            currentReviewUnsubscribe = onSnapshot(q, (snapshot) => {
                reviewList.innerHTML = ''; // 목록 다시 비우기
                if (snapshot.empty) {
                    reviewPlaceholder.textContent = '아직 리뷰가 없습니다. 첫 리뷰를 남겨주세요!';
                    reviewPlaceholder.classList.remove('hidden');
                } else {
                    reviewPlaceholder.classList.add('hidden');
                    snapshot.forEach((doc) => {
                        const review = doc.data();
                        const reviewEl = document.createElement('div');
                        reviewEl.className = 'bg-white p-3 rounded-md shadow-sm border border-gray-200';
                        
                        const textEl = document.createElement('p');
                        textEl.textContent = review.text;
                        textEl.className = 'text-gray-800';
                        reviewEl.appendChild(textEl);

                        if (review.timestamp) {
                            const dateEl = document.createElement('p');
                            dateEl.textContent = new Date(review.timestamp.seconds * 1000).toLocaleString('ko-KR');
                            dateEl.className = 'text-xs text-gray-400 mt-1 text-right';
                            reviewEl.appendChild(dateEl);
                        }
                        reviewList.appendChild(reviewEl);
                    });
                }
            }, (error) => {
                console.error("Error fetching reviews: ", error);
                reviewPlaceholder.textContent = '리뷰를 불러오는 중 오류가 발생했습니다.';
                reviewPlaceholder.classList.remove('hidden');
            });
        }

        // [NEW] --- 리뷰 제출 함수 (Firestore addDoc) ---
        async function submitReview() {
            if (!db || !appId || !currentPickedItem) return;

            const reviewText = reviewInput.value.trim();
            if (reviewText.length === 0) {
                // alert() 대신 UI 피드백 (예: input 흔들기 또는 메시지 표시)
                reviewInput.classList.add('border-red-500', 'animate-shake');
                reviewInput.placeholder = "리뷰 내용을 입력해주세요!";
                setTimeout(() => {
                    reviewInput.classList.remove('border-red-500', 'animate-shake');
                    reviewInput.placeholder = "한 줄 리뷰를 남겨주세요...";
                }, 1000);
                return;
            }

            submitReviewButton.disabled = true;
            submitReviewButton.textContent = "등록중...";

            try {
                const restaurantName = currentPickedItem.name;
                const collectionPath = `artifacts/${appId}/public/data/lunch-reviews/${restaurantName}/reviews`;
                
                await addDoc(collection(db, collectionPath), {
                    text: reviewText,
                    author: userId, // 익명 ID 또는 사용자 ID
                    timestamp: serverTimestamp() // 서버 시간 기준 타임스탬프
                });

                reviewInput.value = ''; // 입력창 비우기

            } catch (error) {
                console.error("Error adding review: ", error);
                // alert() 대신 errorText 사용
                errorText.textContent = `리뷰 등록 오류: ${error.message}`;
                errorText.classList.remove('hidden');
            } finally {
                submitReviewButton.disabled = false;
                submitReviewButton.textContent = "등록";
            }
        }

        // --- 이벤트 리스너 ---
        function setupEventListeners() {
            loadButton.addEventListener('click', loadMenus);
            pickButton.addEventListener('click', pickMenu);

            // Modal functionality
            function openModal(src) {
                if (src && !src.includes('placehold.co')) { 
                    modalImageContent.src = src;
                    imageModal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeModal() {
                imageModal.classList.add('hidden');
                document.body.style.overflow = 'auto';
                modalImageContent.src = '';
            }

            locationImage.addEventListener('click', () => openModal(locationImage.src));
            menuImage.addEventListener('click', () => openModal(menuImage.src));
            foodImage.addEventListener('click', () => openModal(foodImage.src));

            modalClose.addEventListener('click', closeModal);
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    closeModal();
                }
            });

            // [NEW] Review submit listener
            submitReviewButton.addEventListener('click', submitReview);
            reviewInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    submitReview();
                }
            });
        }

        // --- 페이지 로드 시 실행 ---
        // DOM이 로드된 후 스크립트 실행
        window.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM 로드 완료. 스크립트 실행 시작.");

            // [NEW] Firebase 초기화
            await initializeFirebase();
            
            // 이벤트 리스너 설정
            setupEventListeners();
            
            // 하드코딩된 URL 설정 및 자동 로드
            const hardcodedUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSHqg-V9dLAbA_a30oHi1d7fF6UdyuDnIDu7yrJfC9kXuJnu2ow0ZeuSkdkGeZ1reVi878U27s4Hll3/pub?output=csv";
            sheetUrlInput.value = hardcodedUrl;
            
            // 페이지 로드 시 자동으로 메뉴 불러오기
            if (hardcodedUrl) {
                await loadMenus();
            }
        });

    </script>
</body>
</html>

